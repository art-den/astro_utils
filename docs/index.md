# Electra Staking
**Electra** - бесплатная программа для сложения астрофотографий глубокого космоса.

Программа позволяет складывать биас-, дарк-, флэт- и лайт- кадры и на выходе получать
tif или fits-файл с конечным линейным фото, которое можно обрабатывать в других
программах (например в PhotoShop). Это простой аналог DeepSkyStacker.

**Программа находится в ранней разработке.** Автор будет рад любой обратной связи

# Скачать программу
Пока что программа доступна в виде обычного архива. Его нужно распаковать в какой-нибудь
каталог на компьютере. Релизы для Windows выкладываются на яндекс-диске.
Поддерживаются только x64-версии windows начиная с Windows 7.

[ [Скачать программу можно по этой ссылке](https://disk.yandex.ru/d/acwvVPFGZ6gUpQ) ]

Программа выкладывается в нескольких вариантах:
* **electra-stacking-setup-x.x.x-x64-win.exe** - инсталлятор для Windows.
  Самый предпочтительный вариант для использования.
* **electra-stacking-gui-x.x.x-x64-win.7z** - архив с программой без инсталлятора.
  После распаковки надо запустить файл electra_stacking_gui.exe
* **electra-stacking-console-x.x.x-x64-win.7z** - консольный вариант программы
  (без графического интерфейса)

(x.x.x - это номер версии)

# Возможности программы
* Автоматическое выравнивание складываемых снимков по опорному кадру с субпиксельной точностью
  перед сложением
* При сложении используются алгоритмы, которые позволяют убрать ненужные объекты  со снимка
  (треки спутников, метеоры): осреднение с сигма-клиппингом, медианное значение.
* Нахождение и удаление "горячих" пикселей матрицы со снимков (при использовании dark-файлов)
* Сложение несколько сессий с разными параметрами (выдержкой, ISO и т.д.). Программа учитывает
  пересветы на RAW-light-файлах. Если складывать за один заход кадры с пересвеченными участками
  (с длительными выдержками) и кадры без пересвеченных участков (с короткими выдержками),
  программа "скроет" пересвеченные участки, позаимствовав их с кадров с короткими выдержками.
* Программа приводит фон и динамический диапазон всех снимков к фону и диапазону опорного кадра.
  За счёт этого лучше работает сигма-клиппинг (удаление треков спутников и метеоров со снимка)
  и уменьшаются артефакты на краях изображения.
* При большом количестве light-кадров позволяет в автоматическом режиме отключить кадры со
  "смазами", проблемами фокусировки и т.п. Для этого используются такие параметры снимка как FWHM
  звёзд, овальность звёзд, количество звёзд, шум снимка и т.п.
* Использование данных о шуме снимка при сложении. Более шумные кадры имеют меньший вес в
  результирующем изображении, что позволяет увеличить отношение сигнал/шум.

# Как пользоваться программой
Краткое видео по использованию программы [на ютубе](https://youtu.be/hG3dr9aAHs8).
При просмотре видео включите субтитры!

## Подготовка данных и структура проекта
Не обязательно, но желательно распределить исходные файлы по папкам. Это позволит проще создать
проект в программе, а в последствии будет проще разобраться что где находится, если надо будет
заново сложить все снимки.

Обычно файлы раскладываются по типам в папки `lights`, `darks`, `biases`, `flats`. Можно в
названии папки указывать параметры съёмки, например `lights-iso800-300s`. В итоге структура
каталогов проект выглядит как-то так:
```
M31
├── lights-iso800-300s
│   ├── IMG_4005.CR2
│   ├── IMG_4006.CR2
│   └── ....
├── darks-iso800-300s
├── biases-iso800
├── flats
└── M31.es_proj <- файл проекта
```
Если съёмка происходит в несколько сессий, то можно добавить дату в имя объекта и добавить ещё
один уровень вложенности:
```
M31
├── M31-2021.09.20
│   ├── lights-iso800-300s
│   ├── darks-iso800-300s
│   ├── biases-iso800
│   └── flats
├── M31-2021.09.22
│   ├── lights-iso800-60s
│   ├── darks-iso800-60s
│   ├── biases-iso800
│   └── flats
└── M31.es_proj <- файл проекта
```
После выполнения сложения программа сохраняет конечный файл рядом с файлом проекта с тем же
самым именем (в папке `M31` рядом с `M31.es_proj` будет лежать файл `M31.fit`).

## Добавление исходных данных в проект
Добавление файлов в проект выполняется при помощи меню **Обработка -> Добавить файлы ...**.

Если нужно добавить несколько сессий для сложения, то для каждой новой сессии надо создать новую
группу (**Обработка -> Новая группа**), а затем добавить файлы для новой группы. Группы можно
отключать убрав галочку напротив её названия. В этом случае файлы группы не будут включены в
итоговую сумму.

Если вы ошиблись и добавили файлы не в ту группу или не в тот тип файлов, то это легко исправить.
Нужно выделить файлы, которые необходимо переместить, нажать правую кнопку мыши (ПКМ) и выбрать
меню **Переместить файлы в группу** или **Сменить тип файлов**.

Так же через правую кнопку мышки можно удалять файлы или группы из проекта
(**ПКМ -> Убрать из проекта**).

После добавления файлов в проект, его желательно сохранить (**Проект -> Сохранить проект**).

## Просмотр добавленных снимков
Программа отображает изображение из файла в правой части окна, если выбрать файл в дереве проекта.
При просмотре можно выбирать масштаб (выпадающий список "Размер"), гамму изображения (чем больше
гамма, тем больше тёмных участков изображения видно). Флажок **Автоминимум** автоматически вычитает
фон, чтобы объекты на фоне смотрелись более контрастно. Флажок **Авто ББ** автоматически приводит
баланс белого по фону изображения.

Если выбран масштаб `100%`, то просматривать разные части изображения можно зажав кнопку мышки
на картинке и передвигая курсов в нужное направление.

Пересвеченные участки на изображении подсвечиваются зелёным цветом.

## Регистрация снимков
Регистрация снимков необходима только в том случае, если их много и вы хотите автоматически
исключить из сумы неудачные кадры (со смазами, раздутыми звёздами, дымкой, шумом и т.п).

Регистрация запускается при помощи меню **Обработка -> Зарегистрировать файлы изображения**.
После запуска регистрации программа создаст необходимые мастер файлы для калибровочных изоражений
(для dark-, bias- и flat-файлов) и выполнит сложение.

Прогресс регистрации отображается в нижней части окна. Прервать регистрацию можно нажатием кнопки
`Отмена` в нижнем правом углу.

После окончания регистрации программа заполнит колонки проекта, которые в дальнейшем можно
использовать для отбраковки неудачных снимков.

## Отключение неудачных light-снимков
### 1. Вручную
При небольшом количестве снимков самый простой вариант - это вручную просмотреть все снимки и
отключить галочку напротив неудачных. Для этого достаточно выставить масштаб предпросмотра
картинки в 100% и просматривать каждый лайт-кадр, просто щёлкая на него в дереве проекта.

### 2. Полуавтоматически
Перед этим вариантом нужно хотя бы один раз выполнить регистрацию снимков. После чего можно
сортировать дерево проекта по следующим колонкам:
* **FWHM** - размер области половинной яркости непересвеченных звёзд. В данной программе
  измеряется в пикселях с субпиклельной точностью. Больше - хуже. Увеличивается при смазах и
  турбулентности атмосферы.
* **Овальность** - среднеквадратичное отклонение контура звёзд от идеальной окружности.
  Больше - хуже. Увеличивается при смазах.
* **Фон** - процент величины фона от всего динамического диапазона снимка. Больше - хуже.
  Увеличивается при дымке и увеличении засветки неба.
* **Шум** - процент шума от всего динамического диапазона снимка. Больше - хуже.
  Увеличивается при нагреве матрицы и увеличении засветки неба.

После сортировки нужно выделить неудачные отсортированные файлы и отключать их через
**ПКМ -> Убрать отметку с выбранных файлов**

### 3. Автоматически
Перед этим вариантом нужно хотя бы один раз выполнить регистрацию снимков. Для автоматического
отключения предусмотрено меню **Обработка -> Отключить неудачные файлы изображения**.
В окне для отключения можно выбрать параметр, которым будет руководствоваться программа при
отключении:
* По овальности звёзд
* По FWHM
* По количеству звёзд
* По шуму изображения
* По фону изображения

и способ отключения
* **Сигма-клиппинг**. В этом случае будут отключаться те файлы, значения которых сильно выбиваются
по сравнению с остальными. Чем меньше параметр `Kappa`, тем строже будет выполняться проверка.
* **Процент**. В этом случае для каждой группы проекта будет отключаться указанный процент самых
  неудачных изображений.
* **Минимум/максимум**. В этом случае можно просто указать минимальное или максимальное значение,
  при выходе за которые файл будет отключен.

## Выбор опорного кадра
Перед сложением необходимо выбрать опорный кадр. Опорный кадр - это главный кадр на весь проект
(даже если складывается несколько сессий). По опорному кадру будет выполняться выравнивание всех
изображений. Также к нему будет приводится фон и динамический диапазон всех изображений.

В качестве опорного кадра лучше выбирать кадр с большим количеством чётких звёзд, без смазов
и лишних треков.

Сначала выделите light-файл, который будет служить опорным кадром, а затем сделайте его опорным
выбрав **ПКМ -> Использовать как опорный кадр**. Опорный кадр в дереве проекта маркируется
иконкой с ключом.

## Сложение снимков
После отключения неудачных снимков и выбора опорного кадра необходимо запустить сложение.

Это выполняется при помощи меню **Обработка -> Сложить файлы изображения**.
Процесс сложения может происходить довольно долго. Наберитесь терпения.

Прогресс сложения отображается в нижней части окна. Прервать сложение можно нажатием кнопки
`Отмена` в нижнем правом углу.

После завершения сложения программа выдаст об этом сообщение и покажет получившееся изображение.
Для того, чтобы впоследствии ещё раз посмотреть это изображение, необходимо выбрать корень дерева
проекта (с названием проекта).

Результирующее изображение всегда сохраняться в ту же папку, в которую был сохранён файл проекта.

# Аналогичные бесплатные программы
* [DeepSkyStacker](http://deepskystacker.free.fr/english/index.html)
* [Sequator](https://sites.google.com/view/sequator/)
* [Siril](https://siril.org/) (позволяет не только складывать, но и обрабатывать снимки)

# Почему программа называется Electra?
Electra - это [звезда](https://ru.wikipedia.org/wiki/%D0%AD%D0%BB%D0%B5%D0%BA%D1%82%D1%80%D0%B0_(%D0%B7%D0%B2%D0%B5%D0%B7%D0%B4%D0%B0)) в звёздном скоплении Плеяды

